<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Coaching Avanzato 2025 (EAA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .data-input {
            width: 100%;
            padding: 10px 6px;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            background-color: #f8fafc;
            text-align: center;
            font-size: 1rem;
            font-weight: 500;
            color: #1e293b;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 46px;
        }
        .data-input::placeholder {
            color: #94a3b8;
        }
        .data-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        
        /* Hide arrows from number inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        #timer-display {
            font-size: clamp(4rem, 15vw, 6rem);
            font-weight: bold;
            font-family: monospace;
        }
        .timer-status-work {
            color: #16a34a; /* green-600 */
        }
        .timer-status-rest {
            color: #2563eb; /* blue-600 */
        }
        .timer-status-prep {
            color: #f59e0b; /* amber-500 */
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 0.5rem;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8">

    <div class="max-w-screen-2xl mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-6">
        <!-- Main Header -->
        <header class="w-full p-4 mb-6 rounded-lg bg-[#2c3e50] text-white text-center">
            <h1 class="text-xl sm:text-2xl font-bold">üèÉ‚Äç‚ôÇÔ∏è PIANO COACHING AVANZATO 2025: 104kg ‚Üí 95kg | 0' ‚Üí 35' CORSA | TIMING OTTIMIZZATO EAA üéØ</h1>
        </header>

        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex flex-wrap" aria-label="Tabs">
                <button data-tab="piano" class="whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-semibold text-sm text-blue-600 border-blue-600">
                    Dashboard
                </button>
                 <button data-tab="timer" class="whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Workout Timer
                </button>
                 <button data-tab="videos" class="whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Workout Videos
                </button>
                 <button data-tab="spesa" class="whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Lista Spesa
                </button>
                <button data-tab="statistiche" class="whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Statistiche
                </button>
                <button data-tab="progressi" class="whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Obiettivi
                </button>
                <button data-tab="guide" class="whitespace-nowrap py-4 px-3 sm:px-4 border-b-2 font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Guide
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div>
            <!-- Daily Plan / Dashboard Tab -->
            <div data-tab-content="piano">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="card lg:col-span-2">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">üéØ Obiettivi di Oggi (<span id="todayDate"></span>)</h2>
                        <div id="todaySummary" class="space-y-3 text-gray-700">
                            <!-- Summary will be populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                         <h2 class="text-xl font-bold text-gray-800 mb-4">‚ö° Inserimento Rapido</h2>
                         <div id="quickInputs" class="grid grid-cols-2 gap-4">
                            <!-- Quick inputs will be populated by JS -->
                         </div>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-4 mt-8">üóìÔ∏è Piano Completo</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-[#34495e] sticky-header">
                            <tr>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Data</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Giorno</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Pre-Workout</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Functional</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Yoga/Stretching</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Cardio/Corsa</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Colazione</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Spuntino Matt.</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Pranzo</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Spuntino Pom.</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Cena</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Peso</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">FC Med</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Passo</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Sonno</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Cal Bruciate</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Cal Ingerite</th>
                                <th class="px-2 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">Bilancio</th>
                            </tr>
                        </thead>
                        <tbody id="training-plan-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Workout Timer Tab -->
             <div data-tab-content="timer" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Timer Configuration -->
                    <div id="timer-config-panel" class="card">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">üîß Imposta Workout</h2>
                        <div class="grid grid-cols-4 gap-2 mb-2 text-center text-sm font-semibold text-gray-600">
                            <span>Stazione</span>
                            <span>Lavoro (s)</span>
                            <span>Recupero (s)</span>
                            <span>Set</span>
                        </div>
                        <div id="stations-container" class="space-y-4">
                            <!-- Station templates will be inserted here -->
                        </div>
                        <div class="mt-4 border-t pt-4 space-y-4">
                            <div class="flex items-center gap-4">
                               <label for="transition-rest" class="font-semibold text-gray-700">Pausa tra stazioni (s):</label>
                               <input type="number" id="transition-rest" class="data-input w-24" value="30">
                            </div>
                            <div class="flex justify-between items-center">
                                <button id="add-station-btn" class="btn btn-secondary">Aggiungi Stazione</button>
                                 <div class="flex flex-col gap-2 items-start">
                                    <div class="flex items-center">
                                        <input id="countdown-sound-check" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="countdown-sound-check" class="ml-2 block text-sm text-gray-900">Beep Countdown 3-2-1</label>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                    <!-- Timer Display -->
                    <div class="card flex flex-col items-center justify-center text-center">
                         <div id="timer-info" class="mb-4 text-gray-600 h-16">
                            <p id="info-station" class="text-xl font-semibold"></p>
                            <p id="info-set" class="text-lg"></p>
                         </div>
                         <div id="timer-display" class="text-gray-800">00:00</div>
                         <div id="timer-status" class="text-2xl font-bold mt-2">PRONTO</div>
                         <div class="mt-8 flex items-center gap-4">
                            <button id="start-timer-btn" class="btn btn-primary px-6 py-3 text-lg">AVVIA</button>
                            <button id="pause-timer-btn" class="btn btn-secondary px-6 py-3 text-lg hidden">PAUSA</button>
                            <button id="reset-timer-btn" class="btn btn-secondary px-6 py-3 text-lg">RESET</button>
                         </div>
                    </div>
                </div>
             </div>
             
            <!-- Videos Tab -->
            <div data-tab-content="videos" class="hidden">
                <div class="card">
                     <h2 class="text-2xl font-bold text-gray-800 mb-6">üé• Libreria Video Workout</h2>
                     <div id="video-library" class="space-y-8">
                        <!-- Video sections will be populated by JS -->
                     </div>
                </div>
            </div>
            
            <!-- Shopping List Tab -->
            <div data-tab-content="spesa" class="hidden">
                <div class="card max-w-3xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üõí Lista della Spesa</h2>
                    <div class="flex items-center gap-4 mb-6">
                         <button id="generateShoppingListBtn" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.5A5.002 5.002 0 0 0 8 3zM3.5 13A5.002 5.002 0 0 0 8 15c1.552 0 2.94-.707-3.857-1.818a.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.5A5.002 5.002 0 0 0 8 13z"/></svg>
                            Genera per i prossimi 3 giorni
                         </button>
                    </div>
                    <div id="shoppingListContainer" class="space-y-6">
                        <!-- Shopping list will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div data-tab-content="statistiche" class="hidden">
                <div class="mb-6 p-4 border rounded-lg bg-gray-50 flex flex-wrap items-center justify-center gap-4">
                     <h3 class="text-lg font-semibold text-gray-800">Gestione Dati</h3>
                     <button id="exportCsvBtn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                        Esporta CSV
                     </button>
                     <input type="file" id="importCsvInput" accept=".csv" class="hidden"/>
                     <button id="importCsvBtn" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                        Importa CSV
                     </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Andamento del Peso (kg)</h3>
                        <div class="chart-container">
                            <canvas id="weightChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                         <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Bilancio Calorico Giornaliero (kcal)</h3>
                        <div class="chart-container">
                            <canvas id="balanceChart"></canvas>
                        </div>
                    </div>
                    <div class="card col-span-1 lg:col-span-2">
                         <h3 class="text-lg font-semibold text-gray-800 mb-4">‚è±Ô∏è Andamento del Passo (min/km)</h3>
                        <div class="chart-container">
                            <canvas id="paceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress & Goals Tab -->
            <div data-tab-content="progressi" class="hidden">
                 <div class="space-y-8">
                    <section id="progress-tracking"></section>
                    <section id="advanced-goals"></section>
                </div>
            </div>

            <!-- Guides & Parameters Tab -->
            <div data-tab-content="guide" class="hidden">
                <div class="space-y-8">
                    <section id="metabolic-parameters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm"></section>
                    <section id="nutrition-guide"></section>
                    <section id="user-guide" class="card"></section>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CHART.JS INITIALIZATION ---
            let weightChart, balanceChart, paceChart;

            function initializeCharts() {
                const chartOptions = { responsive: true, maintainAspectRatio: false };
                weightChart = new Chart(document.getElementById('weightChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Peso (kg)', data: [], borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.1 }] }, options: chartOptions });
                balanceChart = new Chart(document.getElementById('balanceChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Bilancio Calorico (kcal)', data: [], backgroundColor: [] }] }, options: chartOptions });
                paceChart = new Chart(document.getElementById('paceChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Passo (min/km)', data: [], borderColor: 'rgb(22, 163, 74)', backgroundColor: 'rgba(22, 163, 74, 0.1)', fill: true, tension: 0.1 }] }, options: { ...chartOptions, scales: { y: { reverse: true } } } });
            }

            function updateCharts() {
                const allRows = Array.from(document.querySelectorAll('#training-plan-body tr[data-date]'));
                const labels = allRows.map(row => row.dataset.date.substring(5));
                
                weightChart.data.labels = labels;
                weightChart.data.datasets[0].data = allRows.map(row => { const input = row.querySelector('input[data-metric="peso"]'); return (input && input.value) ? parseFloat(input.value.replace(',', '.')) : null; });
                weightChart.update();
                
                const balances = [], balanceColors = [];
                allRows.forEach(row => {
                    const balanceSpan = row.querySelector('td:last-child span');
                    if (balanceSpan && balanceSpan.textContent) {
                        const v = parseFloat(balanceSpan.textContent);
                        balances.push(v);
                        if (v <= -700 && v >= -900) { balanceColors.push('rgba(74, 222, 128, 0.6)'); } else if (v < -900) { balanceColors.push('rgba(248, 113, 113, 0.6)'); } else { balanceColors.push('rgba(250, 204, 21, 0.6)'); }
                    } else { balances.push(null); balanceColors.push('rgba(209, 213, 219, 0.6)'); }
                });
                balanceChart.data.labels = labels; balanceChart.data.datasets[0].data = balances; balanceChart.data.datasets[0].backgroundColor = balanceColors; balanceChart.update();

                paceChart.data.labels = labels;
                paceChart.data.datasets[0].data = allRows.map(row => { const input = row.querySelector('input[data-metric="passo"]'); return (input && input.value) ? parseFloat(input.value.replace(',', '.')) : null; });
                paceChart.update();
            }

            // --- DATA PERSISTENCE LOGIC ---
            const STORAGE_KEY = 'pianoCoachingData2025_EAA_v6';
            const getStoredData = () => { try { const d = localStorage.getItem(STORAGE_KEY); return d ? JSON.parse(d) : {}; } catch { return {}; } };
            const saveData = (key, value) => { const d = getStoredData(); d[key] = value; localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); };
            function loadAndApplyData(isImport = false) {
                const data = getStoredData();
                document.querySelectorAll('.data-input').forEach(i => { if (data[i.id] !== undefined) { i.value = data[i.id]; if (!isImport) i.dispatchEvent(new Event('input', { bubbles: true })); } });
                if (isImport) { document.querySelectorAll('input[data-metric="calout"]').forEach(i => i.dispatchEvent(new Event('input', { bubbles: true }))); }
                updateProgressTracking(); updateCharts(); updateDashboard();
            }

            // --- TAB NAVIGATION LOGIC ---
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    document.querySelectorAll('[data-tab]').forEach(t => { t.classList.remove('text-blue-600', 'border-blue-600'); t.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300'); });
                    document.querySelectorAll('[data-tab-content]').forEach(c => c.classList.add('hidden'));
                    tab.classList.add('text-blue-600', 'border-blue-600'); tab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    document.querySelector(`[data-tab-content="${targetTab}"]`).classList.remove('hidden');
                    if(targetTab === 'statistiche') { setTimeout(() => [weightChart, balanceChart, paceChart].forEach(c => c.resize()), 0); }
                });
            });
            
            // --- CSV Import/Export LOGIC ---
            const exportBtn = document.getElementById('exportCsvBtn');
            const importBtn = document.getElementById('importCsvBtn');
            const importInput = document.getElementById('importCsvInput');
            importBtn.addEventListener('click', () => importInput.click());
            exportBtn.addEventListener('click', () => {
                const headers = ['date', 'peso', 'fc', 'passo', 'sonno', 'calout', 'calin'];
                let csv = headers.join(',') + '\n';
                document.querySelectorAll('#training-plan-body tr[data-date]').forEach(r => { csv += [r.dataset.date, ...headers.slice(1).map(m => r.querySelector(`input[data-metric="${m}"]`)?.value || '')].join(',') + '\n'; });
                const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = "piano_coaching_data.csv";
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            });
            importInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    let importedData = getStoredData();
                    event.target.result.split('\n').slice(1).forEach(rowStr => {
                        if (!rowStr) return; const cols = rowStr.split(','); const date = cols[0]; if (!date) return;
                        ['peso', 'fc', 'passo', 'sonno', 'calout', 'calin'].forEach((m, i) => { if (cols[i + 1] !== undefined) importedData[`${date}-${m}`] = cols[i + 1].trim(); });
                    });
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
                    loadAndApplyData(true); alert('Dati importati con successo!');
                };
                reader.readAsText(file); e.target.value = '';
            });

            // --- UTILITY FUNCTIONS ---
            const planStartDate = new Date(2025, 8, 24);
            const formatDate = (date) => `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
            const getDayName = (date) => ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"][date.getDay()];
            const tbody = document.getElementById('training-plan-body');

            // --- DYNAMIC UPDATE LOGIC ---
            function updateProgressTracking() {
                const trackingWeeks = [1, 2, 4, 6, 8, 10, 12];
                trackingWeeks.forEach(weekNum => {
                    const dailyRows = document.querySelectorAll(`tr[data-week='${weekNum}']`);
                    if (dailyRows.length === 0) return;
                    let lastWeight = '';
                    for (let i = dailyRows.length - 1; i >= 0; i--) { const weightInput = dailyRows[i].querySelector('input[data-metric="peso"]'); if (weightInput && weightInput.value) { lastWeight = parseFloat(weightInput.value.replace(',', '.')).toFixed(1) + ' kg'; break; } }
                    const pesoCell = document.getElementById(`track-w${weekNum}-peso`); if (pesoCell) pesoCell.textContent = lastWeight;
                    const metricsToAverage = [{ key: 'passo', unit: ' min/km' }, { key: 'fc', unit: ' bpm' }, { key: 'sonno', unit: ' ore' }];
                    metricsToAverage.forEach(metricInfo => {
                        const values = Array.from(dailyRows).map(row => parseFloat(row.querySelector(`input[data-metric="${metricInfo.key}"]`)?.value.replace(',', '.'))).filter(v => !isNaN(v));
                        const targetCell = document.getElementById(`track-w${weekNum}-${metricInfo.key}`);
                        if (targetCell) { if (values.length > 0) { const sum = values.reduce((a, b) => a + b, 0); const avg = sum / values.length; const formattedAvg = metricInfo.key === 'passo' ? avg.toFixed(2) : Math.round(avg); targetCell.textContent = formattedAvg + (metricInfo.unit || ''); } else { targetCell.textContent = ''; } }
                    });
                    const deficitValues = Array.from(dailyRows).map(row => parseFloat(row.querySelector('td:last-child span')?.textContent)).filter(v => !isNaN(v));
                    const deficitCell = document.getElementById(`track-w${weekNum}-deficit`);
                    if (deficitCell) { if (deficitValues.length > 0) { const sum = deficitValues.reduce((a, b) => a + b, 0); const avgDeficit = sum / deficitValues.length; deficitCell.textContent = Math.round(avgDeficit) + ' kcal'; } else { deficitCell.textContent = ''; } }
                });
            }

            // --- UI ELEMENT CREATION FUNCTIONS ---
            function addMetabolicParameters() {
                const container = document.getElementById('metabolic-parameters');
                const paramData = [ { title: "üìä PARAMETRI METABOLICI", items: [["BMR stimato:", "2100 kcal"],["TDEE attuale:", "2900 kcal"],["Intake target:", "2075 kcal"],["Proteine target:", "165g (1.6g/kg)"],["Colazione timing:", "POST-workout 08:00"]]}, { title: "üéØ TARGET SETTIMANALI", items: [["Deficit:", "-825 kcal/giorno"],["Perdita:", "-0.75 kg"],["Controllo peso:", "Gioved√¨ mattina"],["Idratazione:", "3L + 500ml/ora sport"],["Window anabolica:", "30' post-functional"]]}, { title: "üìà PROGRESSIONE CORSA", items: [["Settimana 1-2:", "Walk + 30\" run x10"],["Settimana 3-4:", "1' run / 2' walk x8"],["Settimana 5-6:", "2' run / 1' walk x8"],["Settimana 7-8:", "5' run / 1' walk x5"],["Settimana 9-12:", "35' corsa continua"]]}, { title: "üíä TIMING EAA", items: [["06:15 Pre-workout"],["5 cpr EAA / Caff√®"],["Supporto completo"],["Protezione muscolare"],["Massima ossidazione üî•"]]} ];
                paramData.forEach(section => { const sectionDiv = document.createElement('div'); sectionDiv.className = 'bg-[#ecf0f1] rounded-lg p-3'; const titleEl = document.createElement('h3'); titleEl.className = 'text-sm font-bold bg-[#34495e] text-white -mt-3 -mx-3 mb-3 p-2 rounded-t-lg'; titleEl.textContent = section.title; sectionDiv.appendChild(titleEl); const list = document.createElement('ul'); list.className = 'space-y-1'; section.items.forEach(item => { const li = document.createElement('li'); li.className = 'flex justify-between'; const key = document.createElement('span'); key.className = 'font-semibold'; key.textContent = item[0]; li.appendChild(key); if (item[1]) { const value = document.createElement('span'); value.textContent = item[1]; li.appendChild(value); } list.appendChild(li); }); sectionDiv.appendChild(list); container.appendChild(sectionDiv); });
            }

            function addPhaseSection(title, color) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="18" class="py-3 px-4 text-center text-sm font-bold text-white" style="background-color: ${color};">${title}</td>`;
                tbody.appendChild(tr);
            }

            function addDataRow(data, color, kcalTarget, currentDate) {
                const tr = document.createElement('tr'); const daysSinceStart = (currentDate - planStartDate) / (1000 * 3600 * 24); const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                tr.dataset.week = Math.floor(daysSinceStart / 7) + 1; tr.dataset.date = dateKey; tr.style.backgroundColor = color; tr.className = 'text-xs text-gray-700 align-middle';
                data.slice(0, 11).forEach(cellData => { const td = document.createElement('td'); td.className = 'px-2 py-3 border-b border-gray-200'; td.innerHTML = cellData; tr.appendChild(td); });
                const createInputCell = (metric, placeholder = '') => { const td = document.createElement('td'); td.className = 'px-2 py-3 border-b border-gray-200'; const input = document.createElement('input'); input.type = 'tel'; input.inputMode = 'decimal'; input.className = 'data-input'; input.placeholder = placeholder; input.dataset.metric = metric; input.id = `${dateKey}-${metric}`; td.appendChild(input); return { td, input }; };
                const { td: tdPeso, input: inputPeso } = createInputCell('peso'); tr.appendChild(tdPeso); const { td: tdFc, input: inputFc } = createInputCell('fc'); tr.appendChild(tdFc); const { td: tdPasso, input: inputPasso } = createInputCell('passo', 'min.dec'); tr.appendChild(tdPasso); const { td: tdSonno, input: inputSonno } = createInputCell('sonno', 'ore.dec'); tr.appendChild(tdSonno); const { td: tdCalOut, input: inputCalOut } = createInputCell('calout'); tr.appendChild(tdCalOut); const { td: tdCalIn, input: inputCalIn } = createInputCell('calin'); tr.appendChild(tdCalIn);
                inputCalIn.value = kcalTarget;
                const tdBilancio = document.createElement('td'); tdBilancio.className = 'px-2 py-3 border-b border-gray-200 text-center font-semibold'; const spanBilancio = document.createElement('span'); tdBilancio.appendChild(spanBilancio); tr.appendChild(tdBilancio);
                const calculateBalance = () => {
                    const calOutVal = parseFloat(inputCalOut.value.replace(',', '.')); const calInVal = parseFloat(inputCalIn.value.replace(',', '.'));
                    if (!isNaN(calOutVal) && !isNaN(calInVal)) { const balance = calOutVal - calInVal; spanBilancio.textContent = balance > 0 ? `+${Math.round(balance)}` : Math.round(balance); if (balance <= -700 && balance >= -900) { spanBilancio.className = 'px-2 py-1 rounded-md bg-green-100 text-green-800'; } else if (balance < -900) { spanBilancio.className = 'px-2 py-1 rounded-md bg-red-100 text-red-800'; } else { spanBilancio.className = 'px-2 py-1 rounded-md bg-yellow-100 text-yellow-800'; }
                    } else { spanBilancio.textContent = ''; spanBilancio.className = ''; }
                    updateProgressTracking(); updateCharts();
                };
                [inputPeso, inputFc, inputPasso, inputSonno, inputCalOut, inputCalIn].forEach(input => {
                    input.addEventListener('input', (e) => {
                        saveData(e.target.id, e.target.value);
                        const quickInput = document.querySelector(`input[data-target-id="${e.target.id}"]`); if (quickInput) { quickInput.value = e.target.value; }
                        if (e.target.dataset.metric === 'peso') { const w = parseFloat(e.target.value.replace(',', '.')); if (!isNaN(w) && w <= 95) e.target.classList.add('bg-green-100', 'text-green-800'); else e.target.classList.remove('bg-green-100', 'text-green-800'); }
                        if (['calout', 'calin'].includes(e.target.dataset.metric)) calculateBalance();
                        else { updateProgressTracking(); updateCharts(); }
                    });
                });
                tbody.appendChild(tr);
            }

            function createStaticTable(containerId, title, titleColor, headers, data, headerColor, dataColor) {
                const container = document.getElementById(containerId);
                container.innerHTML = `<h2 class="text-lg font-bold text-white text-center p-3 rounded-t-lg" style="background-color: ${titleColor};">${title}</h2><div class="overflow-x-auto border border-t-0 rounded-b-lg"><table class="min-w-full"><thead style="background-color: ${headerColor};"><tr>${headers.map(h => `<th class="px-4 py-2 text-left text-xs font-bold text-white uppercase">${h}</th>`).join('')}</tr></thead><tbody style="background-color: ${dataColor};">${data.map(row => `<tr class="border-t">${row.map(cell => `<td class="px-4 py-2 text-sm text-gray-700">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
            }

            function generateProgressTrackingTable() {
                const container = document.getElementById('progress-tracking');
                const headers = ["Settimana", "Peso", "Passo Medio", "FC Riposo", "Sonno Medio", "Deficit Medio", "Trend"];
                const weeks = [1, 2, 4, 6, 8, 10, 12]; const trends = ['Baseline', 'Adattamento', 'Progressione', 'Sviluppo', 'Consolidamento', 'Intensificazione', 'TARGET!'];
                let tableBodyHtml = weeks.map((week, index) => `<tr class="border-t"><td class="px-4 py-2 text-sm text-gray-700 font-semibold">Settimana ${week}</td><td class="px-4 py-2 text-sm text-gray-700" id="track-w${week}-peso"></td><td class="px-4 py-2 text-sm text-gray-700" id="track-w${week}-passo"></td><td class="px-4 py-2 text-sm text-gray-700" id="track-w${week}-fc"></td><td class="px-4 py-2 text-sm text-gray-700" id="track-w${week}-sonno"></td><td class="px-4 py-2 text-sm text-gray-700" id="track-w${week}-deficit"></td><td class="px-4 py-2 text-sm text-gray-700">${trends[index]}</td></tr>`).join('');
                container.innerHTML = `<h2 class="text-lg font-bold text-white text-center p-3 rounded-t-lg" style="background-color: #9b59b6;">üìä TRACKING PROGRESSI E PERFORMANCE</h2><div class="overflow-x-auto border border-t-0 rounded-b-lg"><table class="min-w-full"><thead style="background-color: #8e44ad;"><tr>${headers.map(h => `<th class="px-4 py-2 text-left text-xs font-bold text-white uppercase">${h}</th>`).join('')}</tr></thead><tbody style="background-color: #f4f1f7;">${tableBodyHtml}</tbody></table></div>`;
            }

            // --- PLAN GENERATION LOGIC ---
            function generatePhase0() {
                const snacks = ["‚òÄÔ∏è Yogurt Greco 150g + Noci 15g", "üåô Mela + Mandorle 20g", "‚òÄÔ∏è Pane integrale 40g + Tacchino 60g", "üåô 2 Gallette di riso + Ricotta 60g"];
                const data = [
                    ["‚òï Caff√® + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Walk 6km + 30\" run x10", "üßÄ Ricotta 120g + ü•ì Prosciutto 50g", snacks[0], "üçù Pasta 80g + üêü Tonno 100g", snacks[1], "üçó Pollo 150g + ü•î Patate 150g"], // 24/9
                    ["üçØ Miele 5g + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Walk 6km + 30\" run x10", "ü•ö Uova 2 + ü•ì Prosciutto 50g", snacks[2], "üçö Riso 80g + ü•ö Uova 2", snacks[3], "üêü Pesce 150g + üçö Riso 60g"], // 25/9
                    ["‚òï Caff√® + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Walk recupero 45'", "ü•õ Yogurt Greco 200g + ü•ú Noci 25g", snacks[0], "üçù Pasta 80g + üçÖ Pomodoro", snacks[1], "ü¶É Tacchino 150g"], // 26/9
                    ["‚òï Caff√® + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Long Walk 10km + 2'", "üßÄ Ricotta 120g + ü•ì Prosciutto 50g", snacks[2], "üçù Pasta 80g + üêü Tonno 100g", snacks[3], "üçó Pollo 150g + ü•î Patate 150g"], // 27/9
                    ["A piacere / Niente", "üòå Riposo attivo", "-", "üòå Stretching leggero", "ü•ö Uova 2 + ü•ì Prosciutto 50g", snacks[0], "üçö Riso 80g + ü•ö Uova 2", snacks[1], "üêü Pesce 150g + üçö Riso 60g"], // 28/9
                    ["‚òï Caff√® + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Walk recupero 45'", "ü•õ Yogurt Greco 200g + ü•ú Noci 25g", snacks[2], "üçù Pasta 80g + üçÖ Pomodoro", snacks[3], "ü¶É Tacchino 150g"], // 29/9
                    ["‚òï Caff√® + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Walk 6km + 30\" run x10", "üßÄ Ricotta 120g + ü•ì Prosciutto 50g", snacks[0], "üçù Pasta 80g + üêü Tonno 100g", snacks[1], "üçó Pollo 150g + ü•î Patate 150g"], // 30/9
                    ["üçØ Miele 5g + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Walk 6km + 30\" run x10", "ü•ö Uova 2 + ü•ì Prosciutto 50g", snacks[2], "üçö Riso 80g + ü•ö Uova 2", snacks[3], "üêü Pesce 150g + üçö Riso 60g"], // 1/10
                    ["Riposo per viaggio", "üòå Riposo", "-", "üòå Stretching leggero", "Pasti normali", "-", "Pasti normali", "-", "Pasti normali"], // Oct 2nd
                    ["‚òï Caff√® + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Walk recupero 45'", "ü•õ Yogurt Greco 200g + ü•ú Noci 25g", snacks[0], "üçù Pasta 80g + üçÖ Pomodoro", snacks[1], "ü¶É Tacchino 150g"], // 3/10
                    ["‚òï Caff√® + 5 cpr EAA", "üí™ Functional Casa 55'", "üßò‚Äç‚ôÇÔ∏è Stretching 15'", "üö∂‚Äç‚ôÇÔ∏è Long Walk 10km + 2'", "üßÄ Ricotta 120g + ü•ì Prosciutto 50g", snacks[2], "üçù Pasta 80g + üêü Tonno 100g", snacks[3], "üçó Pollo 150g + ü•î Patate 150g"] // 4/10
                ];
                const startDate = new Date(2025, 8, 24);
                data.forEach((row, index) => { const currentDate = new Date(startDate); currentDate.setDate(startDate.getDate() + index); const rowData = [formatDate(currentDate), getDayName(currentDate), ...row]; addDataRow(rowData, "#fff5f5", 2075, currentDate); });
            }

            function generatePause(startDate, endDate) { const current = new Date(startDate); while (current <= endDate) { const rowData = [formatDate(current), getDayName(current), "üí§ Niente", "üò¥ Riposo","-", "üö∂‚Äç‚ôÇÔ∏è Walk leggera 30'", "Colazione normale", "-", "Pranzo normale", "-", "Cena normale"]; addDataRow(rowData, "#f8f9fa", 2200, new Date(current)); current.setDate(current.getDate() + 1); } }
            
            function generatePhase1() {
                const startDate = new Date(2025, 9, 5), endDate = new Date(2025, 9, 31);
                const pre = ["‚òï Caff√® + 5 cpr EAA", "üçØ Miele 5g + 5 cpr EAA"]; 
                const snacks = ["‚òÄÔ∏è Yogurt Greco 150g + Noci 15g", "üåô Mela + Mandorle 20g", "‚òÄÔ∏è Pane integrale 40g + Tacchino 60g", "üåô 2 Gallette di riso + Ricotta 60g"];
                const col = ["üßÄ Ricotta 110g + ü•ì Prosciutto 50g", "ü•ö Uova 2 + ü•ì Prosciutto 50g", "ü•õ Yogurt Greco 180g + ü•ú Noci 25g", "üßÄ Ricotta 110g + üçØ Miele"]; 
                const pra = ["üçù Pasta 75g + üêü Tonno 100g", "üçö Riso 75g + ü•ö Uova 2", "üçù Pasta 75g + üçÖ Pomodoro", "ü´ò Legumi 100g + üçö Riso 60g"]; 
                const cen = ["üçó Pollo 150g + ü•î Patate 150g", "üêü Pesce 150g + üçö Riso 60g", "ü¶É Tacchino 150g", "ü•ö Frittata 3 uova"]; 
                const current = new Date(startDate); 
                let dayCounter = 0;
                while (current <= endDate) { 
                    const d = current.getDay(); 
                    let fun = "", yoga = "-", car = "", preWorkout = "", sp1 = snacks[dayCounter%4], sp2 = snacks[(dayCounter+1)%4];
                    if (d === 0) { preWorkout = "A piacere / Niente"; fun = "üòå Riposo"; car = "üòå Yoga/Stretching"; } 
                    else { const weekInPhase = Math.floor(dayCounter / 6); preWorkout = pre[dayCounter % 2]; yoga = "üßò‚Äç‚ôÇÔ∏è Stretching 15'";
                        if ([1, 3, 5].includes(d)) { fun = "üí™ Self Functional 55'"; car = "üö∂‚Äç‚ôÇÔ∏è Walk recupero 45'"; }  else if ([2, 4].includes(d)) { fun = "üí™ Self Functional 55'"; car = weekInPhase <= 1 ? "üèÉ‚Äç‚ôÇÔ∏è 1' run/2' walk x8" : "üèÉ‚Äç‚ôÇÔ∏è 1.5' run/2' walk x7"; }  else if (d === 6) { fun = "üí™ Self Functional 55'"; car = "üö∂‚Äç‚ôÇÔ∏è Long Walk 12km + 2x3' run"; }
                        dayCounter++;
                    }
                    const mealIndex = Math.floor(dayCounter / 1.5);
                    const rowData = [formatDate(current), getDayName(current), preWorkout, fun, yoga, car, col[mealIndex % 4], sp1, pra[mealIndex % 4], sp2, cen[mealIndex % 4]]; 
                    addDataRow(rowData, "#f0fffe", 2050, new Date(current)); current.setDate(current.getDate() + 1); 
                }
            }
            function generatePhase2() {
                 const startDate = new Date(2025, 10, 4), endDate = new Date(2025, 11, 20);
                 const pre = ["‚òï Caff√® + 5 cpr EAA", "üçØ Miele 5g + 5 cpr EAA"];
                 const snacks = ["‚òÄÔ∏è Yogurt Greco 150g + Noci 15g", "üåô Mela + Mandorle 20g", "‚òÄÔ∏è Pane integrale 40g + Tacchino 60g", "üåô 2 Gallette di riso + Ricotta 60g"];
                 const col = ["üßÄ Ricotta 100g + ü•ì Prosciutto 45g", "ü•ö Uova 2 + ü•ì Prosciutto 45g", "ü•õ Yogurt Greco 170g + ü•ú Noci 22g", "üßÄ Ricotta 100g + üçØ Miele", "ü•ö Frittata 2 uova"]; 
                 const pra = ["üçù Pasta 70g + üêü Tonno 100g", "üçö Riso 70g + ü•ö Uova 2", "üçù Pasta 70g + üçÖ Pomodoro", "ü´ò Legumi 100g + üçö Riso 55g", "üç≤ Minestrone + üçû Pane 40g"]; 
                 const cen = ["üçó Pollo 140g + ü•î Patate 120g", "üêü Pesce 140g + üçö Riso 50g", "ü¶É Tacchino 140g", "ü•ö Frittata 3 uova", "üêü Salmone 120g + ü•¨ Verdure"]; 
                 const current = new Date(startDate); let dayCounter = 0;
                 while (current <= endDate) { 
                    const d = current.getDay(); let fun = "", yoga="-", car = "", preWorkout = "", sp1 = snacks[dayCounter%4], sp2 = snacks[(dayCounter+1)%4];
                    if (d === 0) { preWorkout = "A piacere / Niente"; fun = "üòå Riposo"; car = "üòå Recovery"; } 
                    else { const weekInPhase = Math.floor(dayCounter / 6); preWorkout = pre[dayCounter % 2]; yoga="üßò‚Äç‚ôÇÔ∏è Stretching 15'";
                        if ([1, 3, 5].includes(d)) { fun = "üí™ Functional Palestra 55'"; car = "üö∂‚Äç‚ôÇÔ∏è Walk recupero 45'"; } else if ([2, 4].includes(d)) { fun = "üí™ Functional Palestra 55'"; if (weekInPhase <= 2) car = "üèÉ‚Äç‚ôÇÔ∏è 5' run/1' walk x5"; else if (weekInPhase <= 4) car = "üèÉ‚Äç‚ôÇÔ∏è Corsa continua 25'"; else car = "üèÉ‚Äç‚ôÇÔ∏è Corsa continua 35'"; } else if (d === 6) { fun = "üí™ Functional Palestra 55'"; car = "üö∂‚Äç‚ôÇÔ∏è Long Walk 15km + 2x5' run"; }
                        dayCounter++;
                    }
                    const mealIndex = Math.floor(dayCounter / 1.2);
                    const rowData = [formatDate(current), getDayName(current), preWorkout, fun, yoga, car, col[mealIndex % 5], sp1, pra[mealIndex % 5], sp2, cen[mealIndex % 5]]; 
                    addDataRow(rowData, "#f0f8ff", 2000, new Date(current)); current.setDate(current.getDate() + 1); 
                 }
            }
            
            function generateAnalyticalSections() {
                generateProgressTrackingTable();
                createStaticTable('nutrition-guide', 'ü•ó GUIDA NUTRIZIONALE E TIMING', '#27ae60', ["Timing", "Cosa", "Macro", "Obiettivo"], [["06:15", "Pre-workout", "‚òï Caff√® / Miele + 5 cpr EAA", "Supporto completo muscolare"], ["08:00", "Post-workout", "Colazione completa", "Recovery + saziet√†"], ["13:00", "Pranzo", "Proteine + Carboidrati", "Energia pomeriggio"], ["20:00", "Cena", "Proteine + Verdure", "Recovery notturno"]], '#229954', '#eafaf1');
                createStaticTable('advanced-goals', 'üéØ OBIETTIVI E MILESTONE', '#e74c3c', ["Corsa", "Peso", "Fitness", "Focus"], [["Sett 2: 1' run", "Sett 2: -1.5kg (102.5)", "FC <85 bpm", "Consistenza"], ["Sett 4: 5' run", "Sett 4: -3kg (101kg)", "Passo <18:00", "Progressione"], ["Sett 8: 20' run", "Sett 8: -6kg (98kg)", "Passo <17:00", "Velocit√†"], ["Sett 12: 35' run", "Sett 12: -9kg (95kg)", "Passo <16:30", "TARGET!"]], '#c0392b', '#fadbd8');
                generateUserGuide();
            }
            
            function generateUserGuide() {
                const container = document.getElementById('user-guide');
                container.innerHTML = `
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üí° Guida all'Uso dell'App</h2>
                    <div class="space-y-4 text-gray-700">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">1. Come Inserire Numeri con la Virgola (Es. 102,8)</h3>
                            <p>Quando inserisci dati come il peso o il passo da cellulare, puoi usare sia il <strong>punto (.)</strong> che la <strong>virgola (,)</strong> per i decimali. Il campo √® stato ottimizzato per accettare entrambi i formati senza cancellare il numero, e ti mostrer√† una comoda tastiera numerica.</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">2. Come Salvare e Trasferire i Dati (CSV)</h3>
                            <p>Questa app salva i dati localmente nel browser. Per spostarli tra dispositivi (es. da mobile a PC), usa le funzioni di Import/Export:</p>
                            <h4 class="font-semibold mt-3 mb-1">Su iPhone (iOS):</h4>
                            <ol class="list-decimal list-inside space-y-1 pl-2">
                                <li>Vai su "Statistiche" e premi <strong>"Esporta CSV"</strong>.</li>
                                <li>Tocca l'icona di download nel browser per vedere il file.</li>
                                <li>Seleziona il file e poi tocca l'icona di <strong>condivisione</strong> (quadrato con freccia).</li>
                                <li>Scegli dove inviarlo: "Salva su File" per iCloud, "Copia in Fogli" per Google Sheets, oppure invialo via Mail o altre app.</li>
                            </ol>
                            <h4 class="font-semibold mt-3 mb-1">Su Android:</h4>
                            <ol class="list-decimal list-inside space-y-1 pl-2">
                                <li>Vai su "Statistiche" e premi <strong>"Esporta CSV"</strong>.</li>
                                <li>Apri la barra delle notifiche e tocca il file scaricato.</li>
                                <li>Il sistema ti chieder√† con quale app aprirlo. Scegli <strong>Fogli</strong>, <strong>Drive</strong> o il tuo gestore di file.</li>
                                <li>Da l√¨, puoi salvarlo sul cloud o condividerlo per recuperarlo facilmente dal PC.</li>
                            </ol>
                        </div>
                    </div>
                `;
            }

            // --- DASHBOARD AND SHOPPING LIST LOGIC ---
            function updateDashboard() {
                const today = new Date();
                const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                document.getElementById('todayDate').textContent = formatDate(today);
                const todayRow = document.querySelector(`tr[data-date="${todayKey}"]`);
                const summaryContainer = document.getElementById('todaySummary');
                const quickInputsContainer = document.getElementById('quickInputs');

                if (todayRow) {
                    const cells = todayRow.querySelectorAll('td');
                    summaryContainer.innerHTML = `
                        <p><strong>Pre-Workout:</strong> ${cells[2].textContent}</p>
                        <p><strong>Functional:</strong> ${cells[3].textContent}</p>
                        <p><strong>Yoga/Stretching:</strong> ${cells[4].textContent}</p>
                        <p><strong>Cardio/Corsa:</strong> ${cells[5].textContent}</p>
                        <hr class="my-2">
                        <p><strong>Colazione:</strong> ${cells[6].textContent}</p>
                        <p><strong>Spuntino Mattina:</strong> ${cells[7].textContent}</p>
                        <p><strong>Pranzo:</strong> ${cells[8].textContent}</p>
                        <p><strong>Spuntino Pomeriggio:</strong> ${cells[9].textContent}</p>
                        <p><strong>Cena:</strong> ${cells[10].textContent}</p>
                        <hr class="my-2">
                        <p><strong>Target Calorie:</strong> <span class="font-bold text-blue-600">${todayRow.querySelector('input[data-metric=calin]').value} kcal</span></p>`;
                    
                    const metrics = ['peso', 'fc', 'passo', 'sonno', 'calout', 'calin'];
                    const labels = { peso: '‚öñÔ∏è Peso', fc: 'üíì FC Med', passo: '‚è±Ô∏è Passo', sonno: 'üò¥ Sonno', calout: 'üî• Cal Bruciate', calin: 'üçΩÔ∏è Cal Ingerite' };
                    quickInputsContainer.innerHTML = metrics.map(m => {
                        const originalInput = todayRow.querySelector(`input[data-metric=${m}]`);
                        return `<div class="flex flex-col">
                                    <label for="quick-${m}" class="text-sm font-medium text-gray-600 mb-1">${labels[m]}</label>
                                    <input type="${originalInput.type}" id="quick-${m}" data-target-id="${originalInput.id}" class="data-input" placeholder="${originalInput.placeholder}" inputmode="${originalInput.inputMode}">
                                </div>`
                    }).join('');

                    document.querySelectorAll('#quickInputs input').forEach(quickInput => {
                        const targetInput = document.getElementById(quickInput.dataset.targetId);
                        if (targetInput) {
                            quickInput.value = targetInput.value;
                            targetInput.addEventListener('input', () => { quickInput.value = targetInput.value; }); // Sync from table to quick input
                            quickInput.addEventListener('input', () => { // Sync from quick input to table
                                targetInput.value = quickInput.value;
                                targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                            });
                        }
                    });

                } else {
                    summaryContainer.innerHTML = '<p>Nessun allenamento previsto per oggi.</p>';
                    quickInputsContainer.innerHTML = '';
                }
            }

            function generateShoppingList() {
                const container = document.getElementById('shoppingListContainer');
                container.innerHTML = ''; // Clear previous list
                const today = new Date();
                const aggregatedList = {};
                let dailyBreakdownHTML = '<div class="space-y-4">';

                const parseAndAggregate = (mealText) => {
                    if (!mealText || mealText === "-") return;
                    mealText.split('+').forEach(part => {
                        const cleanedPart = part.replace(/[\d\.]+(\s)?(g|ml|cpr)/gi, '').replace(/[^\w\s.,-]/g, '').trim();
                        const quantityMatch = part.match(/([\d\.]+)\s*(g|ml|cpr|uova)?/i);
                        
                        let name = cleanedPart;
                        let quantity = quantityMatch ? parseFloat(quantityMatch[1]) : 1;
                        let unit = 'pz';
                        if (quantityMatch && quantityMatch[2]) {
                            unit = quantityMatch[2].toLowerCase() === 'uova' ? 'pz' : quantityMatch[2].toLowerCase();
                        }
                        
                        if (!name) return;
                        name = name.charAt(0).toUpperCase() + name.slice(1);
                        const key = name.toLowerCase();

                        if (!aggregatedList[key]) { aggregatedList[key] = { name: name, units: {} }; }
                        if (!aggregatedList[key].units[unit]) { aggregatedList[key].units[unit] = 0; }
                        aggregatedList[key].units[unit] += quantity;
                    });
                };

                for (let i = 0; i < 3; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const row = document.querySelector(`tr[data-date="${dateKey}"]`);
                    if (row) {
                        const cells = row.querySelectorAll('td');
                        dailyBreakdownHTML += `<div>
                            <h3 class="text-lg font-semibold text-gray-700 border-b pb-1 mb-2">${getDayName(date)} - ${formatDate(date)}</h3>
                            <ul class="list-none text-sm space-y-1 pl-2">
                                <li><strong>ü•£ Colazione:</strong> ${cells[6].textContent}</li>
                                <li><strong>‚òÄÔ∏è Spuntino:</strong> ${cells[7].textContent}</li>
                                <li><strong>üçù Pranzo:</strong> ${cells[8].textContent}</li>
                                <li><strong>üåô Spuntino:</strong> ${cells[9].textContent}</li>
                                <li><strong>üçó Cena:</strong> ${cells[10].textContent}</li>
                            </ul>
                        </div>`;
                        [cells[6], cells[7], cells[8], cells[9], cells[10]].forEach(cell => parseAndAggregate(cell.textContent));
                    }
                }
                dailyBreakdownHTML += '</div>';

                let summaryHTML = `<div class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">üìã Riepilogo Spesa Totale</h3>
                    <ul class="space-y-2 list-disc list-inside text-gray-700 columns-1 sm:columns-2">`;
                if (Object.keys(aggregatedList).length > 0) {
                    Object.values(aggregatedList).sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                        let quantityStr = Object.entries(item.units).map(([unit, quantity]) => `${quantity} ${unit}`).join(', ');
                        summaryHTML += `<li><strong>${item.name}:</strong> ${quantityStr}</li>`;
                    });
                } else {
                    summaryHTML += '<li>Nessun pasto trovato per generare una lista.</li>';
                }
                summaryHTML += '</ul></div>';
                container.innerHTML = dailyBreakdownHTML + summaryHTML;
            }
            document.getElementById('generateShoppingListBtn').addEventListener('click', generateShoppingList);
            
            // --- WORKOUT TIMER LOGIC ---
            const stationsContainer = document.getElementById('stations-container');
            const addStationBtn = document.getElementById('add-station-btn');
            const startBtn = document.getElementById('start-timer-btn');
            const pauseBtn = document.getElementById('pause-timer-btn');
            const resetBtn = document.getElementById('reset-timer-btn');
            const timerDisplay = document.getElementById('timer-display');
            const timerStatus = document.getElementById('timer-status');
            const infoStation = document.getElementById('info-station');
            const infoSet = document.getElementById('info-set');
            const countdownSoundCheck = document.getElementById('countdown-sound-check');
            const transitionRestInput = document.getElementById('transition-rest');


            let stationCount = 0;
            let timerInterval;
            let workoutPlan = [];
            let currentPhaseIndex = 0;
            let timeLeft = 0;
            let isPaused = false;
            let synth;

            function playSound(note, duration, time) {
                if (Tone.context.state !== 'running') Tone.start();
                synth = synth || new Tone.Synth().toDestination();
                synth.triggerAttackRelease(note, duration, time);
            }

            function addStation() {
                if (stationCount >= 14) return;
                stationCount++;
                const stationHTML = `
                    <div class="station-item grid grid-cols-4 gap-2 items-center">
                        <span class="font-bold text-gray-700">Stazione ${stationCount}</span>
                        <input type="number" class="data-input work-time" value="45">
                        <input type="number" class="data-input rest-time" value="15">
                        <div class="flex items-center">
                            <input type="number" class="data-input sets" value="3">
                            <button class="remove-station-btn ml-2 text-red-500 hover:text-red-700 text-2xl font-bold">&times;</button>
                        </div>
                    </div>`;
                stationsContainer.insertAdjacentHTML('beforeend', stationHTML);
                stationsContainer.querySelector('.remove-station-btn:last-of-type').addEventListener('click', (e) => {
                    e.target.closest('.station-item').remove();
                    stationCount--;
                    let count = 1;
                    stationsContainer.querySelectorAll('.station-item span').forEach(span => {
                       span.textContent = `Stazione ${count++}`;
                    });
                });
            }
            
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            function buildWorkoutPlan() {
                workoutPlan = [];
                const transitionRest = parseInt(transitionRestInput.value) || 30;
                const stationItems = stationsContainer.querySelectorAll('.station-item');
                stationItems.forEach((item, index) => {
                    const workTime = parseInt(item.querySelector('.work-time').value) || 0;
                    const restTime = parseInt(item.querySelector('.rest-time').value) || 0;
                    const sets = parseInt(item.querySelector('.sets').value) || 0;
                    if (workTime > 0 && sets > 0) {
                        for (let i = 1; i <= sets; i++) {
                            workoutPlan.push({ type: 'LAVORO', duration: workTime, station: index + 1, set: i, totalSets: sets });
                            if (i < sets && restTime > 0) {
                                workoutPlan.push({ type: 'RECUPERO', duration: restTime, station: index + 1, set: i, totalSets: sets });
                            } else if (i === sets && index < stationItems.length - 1 && transitionRest > 0) {
                                workoutPlan.push({ type: 'PAUSA', duration: transitionRest, station: index + 1, set: i, totalSets: sets, isTransition: true });
                            }
                        }
                    }
                });
            }

            function updateTimerDisplay() {
                timerDisplay.textContent = formatTime(timeLeft);
                if (countdownSoundCheck.checked && timeLeft <= 3 && timeLeft > 0) {
                    playSound(timeLeft === 1 ? 'C5' : 'C4', '8n');
                }
            }
            
            function startInitialCountdown() {
                if(Tone.context.state !== 'running') Tone.start();
                buildWorkoutPlan();
                if (workoutPlan.length === 0) { alert("Aggiungi almeno una stazione valida."); return; }
                
                isPaused = false;
                startBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                document.getElementById('timer-config-panel').classList.add('opacity-50', 'pointer-events-none');

                timeLeft = 15;
                timerStatus.textContent = "PREPARATI!";
                timerStatus.className = 'text-2xl font-bold mt-2 timer-status-prep';
                infoStation.textContent = '';
                infoSet.textContent = '';
                playSound('A4', '0.5s');

                timerInterval = setInterval(() => {
                    if (isPaused) return;
                    timeLeft--;
                    updateTimerDisplay();
                    if(timeLeft <= 0) {
                        clearInterval(timerInterval);
                        currentPhaseIndex = 0;
                        runNextPhase();
                    }
                }, 1000);
                updateTimerDisplay();
            }

            function runNextPhase() {
                if (currentPhaseIndex >= workoutPlan.length) {
                    finishWorkout();
                    return;
                }
                const phase = workoutPlan[currentPhaseIndex];
                timeLeft = phase.duration;
                timerStatus.textContent = phase.type;
                timerStatus.className = `text-2xl font-bold mt-2 ${phase.type === 'LAVORO' ? 'timer-status-work' : 'timer-status-rest'}`;
                
                infoStation.textContent = `Stazione ${phase.station}`;
                infoSet.textContent = `Set ${phase.set} di ${phase.totalSets}`;

                playSound(phase.type === 'LAVORO' ? 'G5' : 'C4', '0.5s');

                timerInterval = setInterval(() => {
                    if (isPaused) return;
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        currentPhaseIndex++;
                        runNextPhase();
                    }
                }, 1000);
                updateTimerDisplay();
            }
            
            function pauseTimer() {
                isPaused = !isPaused;
                pauseBtn.textContent = isPaused ? "RIPRENDI" : "PAUSA";
            }
            
            function resetTimer() {
                clearInterval(timerInterval);
                isPaused = false;
                workoutPlan = [];
                currentPhaseIndex = 0;
                timeLeft = 0;
                
                timerDisplay.textContent = "00:00";
                timerStatus.textContent = "PRONTO";
                timerStatus.className = 'text-2xl font-bold mt-2';
                infoStation.textContent = '';
                infoSet.textContent = '';
                
                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                pauseBtn.textContent = "PAUSA";
                document.getElementById('timer-config-panel').classList.remove('opacity-50', 'pointer-events-none');
            }
            
            function finishWorkout() {
                playSound('C6', '1s');
                resetTimer();
                timerStatus.textContent = "FINITO!";
            }
            
            addStationBtn.addEventListener('click', addStation);
            startBtn.addEventListener('click', startInitialCountdown);
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);
            
            for(let i=0; i<8; i++){ addStation(); }

            // --- VIDEO LIBRARY ---
            function generateVideoLibrary() {
                const libraryContainer = document.getElementById('video-library');
                const videoData = {
                    "F45 Workouts": [
                        "uJRLM-1NZEo", "wFRtOd8yqtg", "Th0D5jQbyRo",
                        "LU-aptMaFVE", "jLb3VFcYf8k", "LfvPL1DLmek"
                    ],
                    "DAREBEE Workouts": [
                        "r0uXE8_1dl4", "PyUP10dh8CE", "M6TUlRGyjA4",
                        "EQWiqhVSHdw", "cc6aPyz-qwg", "fy_v8Gndf8g", "wPqofIk8n_0"
                    ],
                    "Esercizi Specifici": [
                        { id: "B2Bi9Xr6d2A", title: "Jumps" },
                        { id: "JhLlu2FMueo", title: "Burpees" }
                    ],
                    "Stretching": [
                        "4PfVFPBgo5s"
                    ]
                };

                for (const category in videoData) {
                    let categoryHtml = `<div>
                        <h3 class="text-xl font-bold text-gray-800 border-b-2 border-gray-200 pb-2 mb-4">${category}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                    
                    videoData[category].forEach((video, index) => {
                        const videoId = typeof video === 'string' ? video : video.id;
                        const videoTitle = typeof video === 'string' ? `${category} #${index + 1}` : video.title;
                        categoryHtml += `
                            <div>
                                <h4 class="font-semibold mb-2 text-gray-700">${videoTitle}</h4>
                                <div class="video-container">
                                    <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            </div>`;
                    });

                    categoryHtml += `</div></div>`;
                    libraryContainer.innerHTML += categoryHtml;
                }
            }

            // --- EXECUTION ---
            addMetabolicParameters(); 
            addPhaseSection("FASE 0 (24/09 - 04/10/2025): Adattamento + Test Baseline", "#ff6b6b"); 
            generatePhase0(); 
            addPhaseSection("FASE 1 (05/10 - 31/10/2025): Build Aerobico", "#4ecdc4"); 
            generatePhase1(); 
            addPhaseSection("PAUSA (01/11 - 03/11/2025): Recupero Attivo", "#95a5a6"); 
            generatePause(new Date(2025, 10, 1), new Date(2025, 10, 3)); 
            addPhaseSection("FASE 2 (04/11 - 20/12/2025): Intensificazione + Target", "#45b7d1"); 
            generatePhase2(); 
            generateAnalyticalSections(); 
            initializeCharts(); 
            generateVideoLibrary(); 
            loadAndApplyData();
        });
    </script>
</body>
</html>

